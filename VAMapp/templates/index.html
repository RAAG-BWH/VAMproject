<!DOCTYPE html>
{% load static %}
<html>
<head>
    <title>Shrike Lab</title>
    <script src='https://www.x3dom.org/download/x3dom.js'> </script>
    <!-- <link rel='stylesheet' type='text/css' href='https://www.x3dom.org/download/x3dom.css'/> -->
    <link rel="stylesheet" type="text/css" href="{% static '/css/style.css' %}">
</head>
<body>
    <div class="header">
        <img id="header-image2" src="{% static '/resources/harvard_bwh.png' %}" alt="Logo1">
        <h1>Volumetric Bioprinting</h1>
        <img id="header-image1" src="{% static '/resources/shrike_logo.png' %}" alt="Logo2">
    </div>
    <div class="x3d-container">
        <x3d width='800px' height='600px' class="canvas_three_d">
            <scene>
               <Inline url="embryo.x3d" id="threed"> </Inline>
            </scene>
        </x3d>
    </div>
    <div class="container">
        <!-- <div id="model-container">
            
            <script type="text/javascript" src="{% static 'js/three.js' %}"></script>
        </div> -->
        <form id="uploadForm" enctype="multipart/form-data" method="post">
            <button id="VoxelButton" type="submit">Voxel STL</button>
            <input type="file" id="file-upload" accept=".stl" name='stl'/><br/>
            <input type="range" id="resolution" min="2" max="500" style="display: inline-block;"><p style="display: inline-block; color: white;" id="res-value"></p>
        </form>
        <script>
            // var container = document.getElementById('model-container'); // Corrected container ID
            // var scene = new THREE.Scene();
            // var camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            // camera.position.z = 5;

            // var renderer = new THREE.WebGLRenderer();
            // renderer.setSize(container.clientWidth, container.clientHeight);
            // container.appendChild(renderer.domElement);

            // var jsonData;

            // Make an AJAX request to fetch the JSON data
            // var xhr = new XMLHttpRequest();
            // xhr.open("GET", "{% url 'voxel' %}", true);
            // xhr.onload = function () {
            //     if (xhr.status === 200) {
            //         jsonData = JSON.parse(xhr.responseText);
                        
            //         // Create a Three.js volume from the JSON data
            //         var width = jsonData.data[0].length;
            //         var height = jsonData.data.length;
            //         var depth = jsonData.data[0][0].length;
            //         var texture = new THREE.DataTexture3D(jsonData.data, width, height, depth);

            //         // Create material, geometry, and mesh
            //         var material = new THREE.ShaderMaterial({
            //             uniforms: {
            //                 volume: { value: texture },
            //             },
            //             vertexShader: document.getElementById('vertexShader').textContent,
            //             fragmentShader: document.getElementById('fragmentShader').textContent,
            //         });

            //         var volumeGeometry = new THREE.BoxGeometry(width, height, depth);
            //         var volumeMesh = new THREE.Mesh(volumeGeometry, material);

            //         scene.add(volumeMesh);

            //         // Animation loop
            //         var animate = function () {
            //             requestAnimationFrame(animate);
            //             volumeMesh.rotation.x += 0.01;
            //             volumeMesh.rotation.y += 0.01;
            //             renderer.render(scene, camera);
            //         };

            //         animate();
            //     }
            // };
            // xhr.send();
            document.getElementById("resolution").addEventListener("change", e => {
                console.log(e.target.value)
                document.getElementById("res-value").innerHTML =  `${e.target.value}`;
            })

            document.getElementById('uploadForm').addEventListener('submit', function(event) {
                event.preventDefault(); 

                var fileInput = document.getElementById('file-upload');
                var file = fileInput.files[0];

                var formData = new FormData();
                formData.append('file-upload', file); 
                formData.append("resolution", document.getElementById("resolution").value)
                console.log(formData, document.getElementById("resolution").value)
                
                var xhr = new XMLHttpRequest();
                xhr.open('POST', 'http://127.0.0.1:8000/home/', true); 

                
                xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));

                xhr.onload = function() {
                    if (xhr.status === 200) {
                        console.log('Archivo subido correctamente');
                        var response = JSON.parse(xhr.responseText);
                        console.log(response); 
                        document.getElementById("threed").setAttribute("url", "embryo.x3d")
                    } else {
                        console.error('Error al subir el archivo:', xhr.responseText);
                    }
                };

                xhr.send(formData);
            });

            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        </script>
    </div>
</body>
</html>
